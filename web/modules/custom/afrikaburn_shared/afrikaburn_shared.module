<?php

/**
 * @file
 * Contains Afrikaburn Shared module.
 */

use \Drupal\Core\Form\FormStateInterface;
use \Drupal\Core\Entity\EntityInterface;
use \Drupal\Core\Entity\Display\EntityViewDisplayInterface;
use \Drupal\user\Entity\User;

/**
 * Implements hook_form_alter().
 * Hooked to attach form behaviour, hide revision section.
 */
function afrikaburn_shared_form_alter(&$form, $form_state, $form_id) {

  if ($form_id == 'user_form') {
    if (preg_match('/user\/reset/', \Drupal::request()->server->get('HTTP_REFERER'))) {
      $response = new Symfony\Component\HttpFoundation\RedirectResponse(\Drupal::url('<front>'));
      $response->send();
    }
  }

  module_load_include('inc', 'afrikaburn_shared', 'includes/form');

  static $user;
  $user = isset($user) ? $user : User::load(\Drupal::currentUser()->id());
  list($registration, $registration_title) = _get_registration();
  list($collective, $collective_title) = _get_collective($registration);

  _set_registration_form_title($form, $form_id, $collective_title, $registration_title);
  _set_registration_form_defaults($form, $form_id, $user, $collective);
  _set_collective_defaults($form, $form_id, $user);

}

/**
 * Implements hook_entity_update().
 */
function afrikaburn_shared_entity_update($entity){
  $user = $entity->getEntityType()->id() == 'user' ? $entity : FALSE;
  if ($user){
    if (!($user->get('field_quicket_id')->count() && $user->get('field_quicket_id')->count())){
      module_load_include('inc', 'afrikaburn_shared', 'includes/quicket');
      afrikaburn_shared_quicket_new_code($user);
    }
  }
}

/**
 * Implements hook_user_login().
 * Hooked to redirect users to the home page
 */
function afrikaburn_shared_user_login($account){
  if (\Drupal::service('path.current')->getPath() == '/user/login'){
    $response = new Symfony\Component\HttpFoundation\RedirectResponse(\Drupal::url('<front>'));
    $response->send();
  }
}

/**
 * Implements hook_preprocess_input().
 * Change "Save" to "Submit"
 */
function afrikaburn_shared_preprocess_input(&$variables) {
  if (
    preg_match(
      '/node\/add\/(art|mutant_vehicles|performances|theme_camps)/', 
      \Drupal::service('path.current')->getPath()
    ) 
      && isset($variables['attributes']['value'])
      && $variables['attributes']['value'] == t('Save and publish')
  ) {
    $variables['attributes']['value'] = t('Submit');
  }
}

/**
 * Implements hook_views_pre_view().
 * Hooked to set collective on drop down view selects
 */
function afrikaburn_shared_views_pre_view(\Drupal\views\ViewExecutable $view, $display_id, &$args){
  if ($view->id() == 'collective_members' && $display_id == 'entity_reference_1'){
    $node = \Drupal::routeMatch()->getParameter('node');
    if ($node && $node->field_collective){
      $args[0] = $node->field_collective->first()->getValue()['target_id'];
    } else if ($cid = \Drupal::request()->query->get('field_collective')) {
      $args[0] = $cid;
    }
  }
}

// /**
//  * Checks whether to display the project links
//  */
// function afrikaburn_shared_show_project_links(){

//   $node = \Drupal::routeMatch()->getParameter('node');

//   if ($node && $node->bundle() == 'collective'){
//     $uid = \Drupal::currentUser()->id();
//     foreach($node->field_col_admins as $admin){
//       if ($admin->getValue()['target_id'] == $uid) return TRUE;
//     }
//   }

//   return FALSE;
// }
